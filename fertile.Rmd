---
title: "Creating optimal conditions for reproducible data analysis in R with `fertile`"

# to produce blinded version set to 1
blinded: 0

authors: 
- name: Audrey Bertin
  thanks: The authors gratefully acknowledge contributions from Hadley Wickham, Jenny Bryan, Greg Wilson, Edgar Ruiz, and other members of the `tidyverse` team. 
  affiliation: Program in Statistical and Data Sciences, Smith College
  
- name: Benjamin S. Baumer
  affiliation: Program in Statistical and Data Sciences, Smith College

keywords:
- reproducibility
- statistical software
- workflow
- collaboration

abstract: |
  
  The advancement of scientific knowledge increasingly depends on ensuring that data-driven research is reproducible: that two people with the same data obtain the same results. However, while the necessity of reproducibility is clear, there are significant behavioral and technical challenges that impede its widespread implementation, and no clear consensus on standards of what constitutes reproducibility in published research. We focus on a series of common mistakes programmers make while conducting data science projects in R, primarily through the RStudio integrated development environment. `fertile` is an R package that operates in two modes: proactively (to prevent reproducibility mistakes from happening in the first place), and retroactively (analyzing code that is already written for potential problems). Furthermore, `fertile` is designed to educate the user about why the mistakes are problematic, and how to fix them. We discuss experimental results from testing `fertile` in an introductory data science course.


bibliography: [bibliography.bib, pkgs.bib]
output: rticles::asa_article

---

```{r, include = FALSE}
knitr::write_bib(c("dplyr", "rrtools", "tidyverse", "orderly", "workflowr", "testthat"),  file = "pkgs.bib")
```

# Introduction

Data-based research cannot be fully *reproducible* unless the requisite code and data files produce identical results when run by another analyst. 

As research is becoming increasingly data-driven, and because knowledge can be shared worldwide so rapidly, reproducibility is critical to the advancement of scientific knowledge.

When researchers provide the code and data used for their work in a well-organized and reproducible format, readers are more easily able to determine the veracity of any findings by following the steps from raw data to conclusions. 

The creators of reproducible research can more easily receive more specific feedback (including bug fixes) on their work. Moreover, others interested in the research topic can use the code to apply the methods and ideas used in one project to their own work with minimal effort.

However, while the necessity of reproducibility is clear, there are significant behavioral and technical challenges that impede its widespread implementation, and no clear consensus on standards of what constitutes reproducibility in published research (@peng2009bio). Not only are the *components* of reproducible research up for discussion (e.g., need the software be open source?), but the corresponding *recommendations* for ensuring reproducibility also vary (e.g., should raw and processed data files be in separate directories?).

Much of the discussion around reproducibility is also generalized---it is written to be applicable to users working with a variety of statistical software programs. Since all statistical software programs operate differently, generalized recommendations on reproducibility are often shallow and unspecific. While they provide useful guidelines, they can often be difficult to implement, particularly to new analysts who are unsure how to apply such recommendations within the software programs they are using.

Thus, reproducibility recommendations tailored to specific software programs are more likely to be adopted. 

In this paper, we focus on reproducibility in the R programming language with a concentration on projects that use the RStudio integrated development environment.

R is an ideal candidate for reproducibility recommendations due to the language's popularity for statistical analyses and the ease with which analysts can download and begin using the software.  
Several researchers and R users have recognized this and worked to publish a small body of papers and R packages focusing on increasing reproducibility in the R community.

Much of this work is narrowly tailored, with each package effectively addressising a small component of reproducibility--file structure, modularization of code, version control, etc. 
Many existing reproducibility packages, due to their focused nature, succeed at their area of focus well, but at a cost. They are often semi-complex to learn and operate, providing a barrier to entry for less-experienced data analysts. 

There appear to be no existing tools that cater to analysts looking for an easy-to-learn, easy-to-implement, fast way to obtain a broad overview of their projects' reproducibility.
To address this, we present an R package called [**fertile**](https://github.com/baumer-lab/fertile) [^1].

[^1]:{The authors gratefully acknowledge contributions from Hadley Wickham, Jenny Bryan, Greg Wilson, Edgar Ruiz, and other members of the **tidyverse** team.}, a low barrier-to-entry package which focuses on a series of common mistakes programmers make while conducting data science research in R.


# Literature Review

As is becoming increasingly clear, reproducibility is critically important to the advancement of knowledge in all fields of scientific research. Researchers appear to be acknowledging this, as publications focusing on reproducibility seem to have increased in frequency over the last several years. 

Much of the available literature is focused on the methods for achieving reproducibility in specific disciplines, though much of this information is generalizable to all areas of scientific research. There is also a small body of work focusing on reproducibility within the R community specifically. Some of this work is in the form of academic papers, while other literature comes from the blog posts and websites of several highly-regarded R-focused websites and researchers.  In this section, we will discuss the reproducibility recommendations from both the formal and informal publications, which together influenced which features were included in **fertile**.

There is also a small existing body of R packages focused on providing tools to assist researchers with achieving reproducibility. We will consider the functionality of these packages, identifying **fertile**'s unique role and functionality. 

## Published Literature

As argued by @Goodman341ps12, the language and conceptual framework of research reproducibility vary across the sciences. There are no clear standards agreed upon across fields. 

The variety of recommendations and techniques for achieving reproducibility can be clearly seen in @kitzes2017practice, a collection of case studies on reproducibility practices from across the data-intensive sciences. Although the book idenfies no consensus on exact standards of reproducibility, several common trends and principles emerge from the case studies:

1. Use clear separation, labeling and documentation.
2. Automate processes when possible.
3. Design the data analysis workflow as a sequence of small steps glued together, with outputs from one step serving as inputs into the next.

@cooper2017guide, focused on data analysis in R, identifies similar important reproducibility components, reiterating the need to clearly labled, well-documented, and well-separated files. In addition, the paper recommends that a list of dependencies be published and version control be used.

Karl Broman, Professor of Biostatistics and Medical Informatics at the University of Wisconsin, Madison, reiterates the need for clear naming and file separation while sharing several additional suggestions: keep the project contained in one directory, use relative paths, and include a README. 

R OpenSci's reproducibility recommendations share similar components to those discussed previously. They focus on a need for a well-developed file system, with no extraneous files and clear labeling. They also reiterate the need to note dependencies and use automation when possible, while making clear a suggestion not present in the previously-discussed literature: the need to use seeds when running code involving randomness.

When considered in combination, these sources provide a well-rounded picture of the components important to research reproducibility. Using this literature as a guideline, we identify several key features of reproducible work to focus on:

• A well-designed file structure:
  - Separate folders for different file types.
  - No extraneous files.
  - Minimal clutter.
  
• Good documentation:
  - Files are clearly named, preferably in a way where the order in which they should be run is clear.
  - A README is present.
  - Dependencies are noted.
  
• Reproducible file paths:
  - No absolute paths, or paths leading to locations outside of a project's directory, are used in code. Only portable (relative) paths.
  
• Randomness is accounted for:
  - If randomness is used in code, a seed must also be set.
  
• Code conforms to tidyverse style      

Much of the available literature focuses on file structure, organization, and 
naming, and **fertile**s features are consistent with this. The *ideal* file 
structure is not agreed upon by academics, though there are some recommendations 
focused on R that are available. @marwick2018packaging provides the framework for 
file structure that **fertile** is based on: a structure similar to that of an R 
package, with an `R` folder, as well as `data`, `data-raw`, `inst` and `vignettes`. 


## R Packages


There also exists a small selection of R packages that work to address the issue of research reproducibility, though not all of them are available on `CRAN`. 

**rrtools** [@R-rrtools], developed to address some of the issues discussed in @marwick2018packaging, creates a basic R package structure for a data analysis project and implements a basic **testthat**::`check` functionality. The **orderly** [@R-orderly] package also focuses on file structure, requiring the user to declare a desired project structure (typically a step-by-step structure, where outputs from one step are inputs into the next) at the beginning and then creating the files necessary to achieve that structure. **workflowr**'s [@R-workflowr] functionality is based around version control and making code easily available online. It works to generate a website containing time-stamped, versioned, and documented results. **checkers** [@R-checkers] allows you to create custom checks that look at different aspects of reproducibility. **packrat** [@R-packrat] is focused on dependencies, creating a packaged folder containing a project as well as all of its dependencies, so that projects dependent on lesser-used packages can be easily shared across computers. Lastly, the **reproducible** [@R-reproducible] package focuses on the concept of caching--saving information so that projects can be run faster each time they are re-completed from the start. 

Many of these packages focus on one specific area of reproducibility, and while they each succeed well at their intended goal, they are not necessarily the most practical option for users trying to address a wide variety of factors influencing reproducibility at once. 

Additionally, with the focused nature of these packages comes added complexity. The functions in these packages are often quite complex to use, and many steps must be completed to achieve the required reproducibility goal. This complex nature means that most reproducibility packages currently available are not easily accessible to users near the beginning of their R journey, nor particularly useful to those looking for quick and easy reproducibility checks. 


# Methods

**fertile** looks to address these gaps, providing a simple, easy-to-learn reproducibility package that, rather than focusing intensely on a specific area, provides some information about a wide variety of aspects influencing reproducibility. 

The package also provides flexibility--offering benefits to users at any stage in the data analysis workflow, unlike some other available packages which can only be used before the creation of a new project or after it is finished.

It is designed to be used on data analyses organized as R Projects (i.e. folders containing a `.Rproj` file). Once an R Project is created, **fertile** provides benefits throughout the data anlaysis process, both while coding as well as after the fact.

**fertile** achieves this by operating in two modes: proactively (to prevent reproducibility mistakes from happening in the first place), and retroactively (analyzing code that has already been written for potential problems). 


## Proactive Use

Proactively, the package identifies potential mistakes as they are made by the user and outputs an informative message as well as a recommended solution. For example, **fertile** catches when a user passes a potentially problematic file path---such as an absolute path, or a path that points to a location outside of the project directory---to a variety of common input/output functions operating on many different file types. 

```{r setup, cache = F, include = FALSE}
knitr::opts_chunk$set(error = TRUE, collapse = TRUE)
```

```{r, include = FALSE, message = FALSE}
readr::write_csv(mtcars, "~/Desktop/my_data.csv")
library(tidyverse)
library(fertile)
```

```{r, message = FALSE}
file.exists("~/Desktop/my_data.csv")
read_csv("~/Desktop/my_data.csv")
```

```{r}
read.table("~/Desktop/my_data.csv")
```

**fertile** is even more aggressive with functions (like `setwd()`) that are almost certain to break reproducibility, causing them to throw errors that prevent their execution.

```{r, message = FALSE}
setwd("~/Desktop")
```

The proactive features are activated immediately after loading the **fertile** package and require no additional effort by the user to access.


## Retroactive Use

Retroactively, **fertile** analyzes potential obstacles to reproducibility in an RStudio Project (i.e., a directory that contains an `.Rproj` file), including the directory structure, the analyst's use of file paths, randomness, etc. **fertile** creates reproducibility reports that identify potential mistakes and provide recommendations for remedies. For example, **fertile** might identify the use of randomness in code and recommend setting a seed.

Users can access the majority of **fertile**'s retroactive features through two primary functions.

The `proj_check()` function runs fifteen different reproducibility tests, noting which ones passed, which ones failed, the reason for failure, a recommended solution, and a guide to where to look for help. These tests include: looking for a clear build chain, checking to make sure the root level of the project is clear of clutter, confirming that there are no files present that are not being directly used by or created by the code, and looking for uses of randomness that to not have a call to `set.seed()` present. Subsets of the fifteen tests can be invoked using the select helper functions from **dplyr** and the `proj_check_some()` function.

```{r, message = FALSE}
library(tidyverse)
proj_check_some(".", contains("paths"))
```

The `proj_analyze()` function creates a report documenting the structure of a data analysis project. This report contains informations about all packages referenced in code, the files present in the directory and their types, suggestions for moving files to create a more organized structure, and a list of reproducibility-breaking file paths used in code.

\tiny
```{r, message = FALSE}
proj_analyze(".")
```
\normalsize





## Utility Functions

**fertile** also provides several useful utility functions. Among other things, these include functions to check the type of a file and a way to create a copy of a project in a temporary directory.

```{r}
is_path_portable("~")

is_data_file("~/Desktop/my_data.csv")
is_image_file("~/Desktop/my_data.csv")
```

```{r}
dir <- getwd()
new_dir <- sandbox(dir)
```

\tiny
```{r}
dir
fs::dir_ls(dir) %>% head()
```

```{r}
new_dir
fs::dir_ls(new_dir) %>% head()
```
\normalsize


## Sample Use Cases

**fertile** is designed in such a way as to be useful to users of all backgrounds and experiences. In this section, we provide two sample use cases demonstrating situations where users could benefit significantly from using the package. 

### Introductory Data Science Student

Susan is taking an introductory data science course. This is her first time learning how to code, and she has not yet been exposed to ideas of research reproducibility. Her professor has assigned a data analysis project which must be completed in R Markdown. The project requires her to read in a data file located on her computer and use it to produce a graph. 

She reads in the data, makes the graph, and knits her .Rmd file. It compiles successfully, so she submits the assignment. The next day, she receives an email from her professor saying that her assignment failed to compile and that she needs to make changes and try again. 

Susan doesn't understand why it didn't work on the professor's computer when it did on her own. The professor recommends that she install **fertile** and run `proj_check()` on her assignment. She does this and gets a message informing her she used an absolute path to open her dataset, and she should use a relative path. She looks up what this means and then uses the new information to update her assignment. She resubmits and her second attempt is successful. 

On future projects, she always loads and runs fertile to make sure her work is okay before submitting.

### 2. Experienced R User

Emma is a post-doc, with several years of R experience. She is familiar with some basic rules of reproducibility--file paths should always be relative and randomness should always be associated with a seed--but has never needed to pass any sort of reproducibility check before because her professors never emphasized that.

She has just finished a research project and is looking to submit her work to a journal. When researching the journal she is interested in submitting to, she discovers that it has high standards for research reproducibility and a dedicated editor focusing on that aspect of submissions. She goes online and finds the journal's guidelines for reproducibility. They are more complete than any guidelines she has previously been required to conform to. In addition to notes about file paths and randomness, the journal requires a clean, well-organized folder structure, broken down by file category and cleaned of files that do not serve a purpose.

Unsure of the best way to achieve this structure, Emma goes online to find help. In her search, she comes across **fertile**. She downloads the package, and in only a handful of commands, she identifies and removes excess files in her directory and automatically organizes her files into a structure reminiscent of an R package. She now meets the guidelines for the journal and can submit her research.

# Results

In an effort to understand the package's effectiveness, we also share preliminary results from a randomized, controlled experiment conducted on an undergraduate introductory data science course [^2]:{This study is approved by Smith College IRB, Protocol #19-032}. The purpose of the study is to determine whether **fertile** helps students produce data science research that is more likely to be reproducible. 

# Conclusion


**fertile** is an R package that lowers barriers to reproducible data analysis projects in R. 
The features of **fertile** can be accessed almost effortlessly, making it easy for data analysts of all skill levels and backgrounds to gain a better understanding of how to make their work reproducible.
**fertile** is designed to educate the user about why the mistakes are problematic and how to fix them, promoting a greater understanding of reproducibility concepts in its users.
It is written for a wide audience, simple enough to be used by students in an introductory data science course, but still helpful to experienced analysts.
**fertile** also addresses a human challenge of reproducibility. In the moment, it often feels easiest to take a shortcut---to use an absolute path or change a working directory. However, when considering the long term path of a project, spending the extra time to improve reproducibility is worthwhile. **fertile**'s user-friendly features can help data analysts avoid these harmful shortcuts with minimal effort.


